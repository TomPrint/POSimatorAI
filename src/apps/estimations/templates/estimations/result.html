{% extends "base.html" %}

{% block extra_css %}
<style>
  .cute-robot-v1 {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1.5rem 0 0.5rem;
  }

  .cute-robot-v1 * {
    box-sizing: border-box;
  }

  .cute-robot-v1 .circle-bg {
    background: #f6f5f3;
    width: 220px;
    height: 220px;
    border-radius: 100%;
    border: 6px solid #3d3d3f;
    position: relative;
  }

  .cute-robot-v1 .circle-bg::after {
    content: "";
    position: absolute;
    z-index: 2;
    height: 100%;
    width: 100%;
    top: -2px;
    left: 0;
    border-radius: 100%;
    border-bottom: 8px solid #3d3d3f;
  }

  .cute-robot-v1 .robot-head {
    height: 170px;
    width: 170px;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    top: -18px;
    border: 6px solid #3d3d3f;
    border-radius: 80px / 56px;
    background: #ffffff;
    z-index: 4;
  }

  .cute-robot-v1 .robot-head::after {
    content: "";
    position: absolute;
    top: -26px;
    height: 24px;
    width: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #3d3d3f;
  }

  .cute-robot-v1 .robot-head::before {
    content: "";
    position: absolute;
    top: -52px;
    left: 50%;
    transform: translateX(-50%);
    height: 18px;
    width: 18px;
    background: #f6f5f3;
    border: 6px solid #3d3d3f;
    border-radius: 100%;
  }

  .cute-robot-v1 .robot-face {
    height: 110px;
    width: 140px;
    background: #e1f4f0;
    position: absolute;
    top: 40px;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid #3d3d3f;
    border-radius: 40px;
    transition: all 200ms;
  }

  .cute-robot-v1 .eyes {
    height: 18px;
    width: 18px;
    background: #3d3d3f;
    border-radius: 100%;
    position: absolute;
    top: 36px;
    animation: eye-bob 4s ease-in-out infinite;
  }

  .cute-robot-v1 .eyes.left {
    left: 26px;
  }

  .cute-robot-v1 .eyes.right {
    right: 26px;
  }

  .cute-robot-v1 .mouth {
    height: 40px;
    width: 40px;
    border-radius: 100%;
    border: 6px solid transparent;
    border-bottom-color: #3d3d3f;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    top: 46px;
    overflow: hidden;
    animation: smile-toggle 4s ease-in-out infinite;
  }

  .cute-robot-v1 .mouth::after {
    content: "";
    position: absolute;
    height: 80%;
    width: 80%;
    bottom: -30%;
    left: 50%;
    transform: translateX(-50%);
    background: #f9bbbb;
    border-radius: 100%;
    opacity: 0;
    animation: tongue-toggle 4s ease-in-out infinite;
  }

  .cute-robot-v1 .robot-ear {
    position: absolute;
    height: 90px;
    width: 90px;
    border-radius: 100%;
    background: #ffffff;
    border: 6px solid #3d3d3f;
    z-index: 3;
    top: 30px;
  }

  .cute-robot-v1 .robot-ear.left {
    left: -16px;
  }

  .cute-robot-v1 .robot-ear.right {
    right: -16px;
  }

  .cute-robot-v1 .robot-body {
    height: 45px;
    width: 90px;
    border: 6px solid #3d3d3f;
    background: #ffffff;
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-radius: 22px 22px 26px 26px;
  }

  @keyframes smile-toggle {
    0%, 45% { border-bottom-color: #3d3d3f; }
    55%, 100% {
      border: 6px solid #3d3d3f;
      clip-path: polygon(0% 30%, 100% 30%, 100% 100%, 0% 100%);
    }
  }

  @keyframes tongue-toggle {
    0%, 45% { opacity: 0; }
    55%, 100% { opacity: 1; }
  }

  @keyframes eye-bob {
    0%, 45% { transform: translateY(0); }
    55%, 100% { transform: translateY(-4px); }
  }

  .verify-result {
    white-space: pre-wrap;
    max-height: 320px;
    overflow-y: auto;
    border: 1px solid #e5e5e5;
    background: #ffffff;
    padding: 0.75rem;
    border-radius: 12px;
  }

  .verify-badges {
    display: inline-flex;
    gap: 0.5rem;
    align-items: center;
  }

  .verify-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.2rem 0.5rem;
    border-radius: 999px;
    border: 1px solid #e5e5e5;
    background: #f7f7f7;
    font-size: 0.7rem;
    letter-spacing: 0.02em;
  }

  .verify-dot {
    width: 16px;
    height: 16px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.65rem;
    color: #ffffff;
    background: #1a73e8;
  }

  .verify-dot.gemini {
    background: #0f9d58;
  }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-8">
    <div class="card card-soft p-4 p-md-5">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div>
          <div class="brand-logo">
            <span class="brand-mark">P</span>
            POSimatorAI
          </div>
          <h1 class="mt-3 fw-bold mobile-title">Wynik estymacji</h1>
          <p class="text-muted mobile-text-lg mb-0">Podsumowanie wyceny.</p>
        </div>
        <a href="{% url 'estimations' %}" class="btn btn-brand btn-lg">Nowa estymacja</a>
      </div>

      <div class="row g-3 g-md-4 mt-2">
        <div class="col-12 col-md-6">
          <div class="card card-soft p-3 h-100">
            <div class="text-uppercase small text-muted">Predykcja</div>
            <div class="fs-4 fw-bold mt-2">{{ predicted }} zł</div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card card-soft p-3 h-100">
            <div class="text-uppercase small text-muted">Twoja wycena</div>
            <div class="fs-4 fw-bold mt-2">{{ user_price }} zł</div>
          </div>
        </div>
      </div>

      <!-- Karta z informacjami o modelu -->
      <div class="row g-3 g-md-4 mt-4">
        <div class="col-12">
          <div class="card card-soft p-3">
            <div class="text-uppercase small text-muted mb-2 text-center">Informacje o modelu</div>
            <div class="row text-center">
              <div class="col-6 col-md-3 mb-2">
                <div class="text-muted small">Nazwa</div>
                <div class="fw-bold small">{{ model_name }}</div>
              </div>
              <div class="col-6 col-md-3 mb-2">
                <div class="text-muted small">Typ</div>
                <div class="fw-bold small">{{ model_type }}</div>
                
              </div>
              <div class="col-6 col-md-3 mb-2">
                <div class="text-muted small">MAE</div>
                <div class="fw-bold">{{ model_mae }}</div>
              </div>
              <div class="col-6 col-md-3 mb-2">
                <div class="text-muted small">R²</div>
                <div class="fw-bold">{{ model_r2 }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Koniec karty modelu -->

      <div class="row g-3 g-md-4 mt-4">
        <div class="col-12">
          <div class="card card-soft p-3">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
              <div>
                <div class="text-uppercase small text-muted">Sprawdź ceny online z AI</div>
                <div class="text-muted small">Użyj Gemini Google Search do prognozy ceny.</div>
                <div class="verify-badges mt-2">
                  <span class="verify-badge">
                    <span class="verify-dot">G</span>
                    Google Search
                  </span>
                  <span class="verify-badge">
                    <span class="verify-dot gemini">G</span>
                    Gemini
                  </span>
                </div>
              </div>
              <button
                class="btn btn-outline-dark"
                id="verifyPriceButton"
                data-submission-id="{{ submission_id }}"
                {% if not submission_id %}disabled{% endif %}
              >
                Weryfikacja Gemini AI
              </button>
            </div>
            <div id="verifyPriceStatus" class="small text-muted mt-3 d-none"></div>
            <div id="verifyPriceResult" class="verify-result mt-3 small"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="submitSuccessModal" tabindex="-1" aria-labelledby="submitSuccessModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 card-soft">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="submitSuccessModalLabel">Estymacja zapisana</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
      </div>
      <div class="modal-body text-center pt-0">
        <div class="cute-robot-v1">
          <div class="circle-bg">
            <div class="robot-ear left"></div>
            <div class="robot-head">
              <div class="robot-face">
                <div class="eyes left"></div>
                <div class="eyes right"></div>
                <div class="mouth"></div>
              </div>
            </div>
            <div class="robot-ear right"></div>
            <div class="robot-body"></div>
          </div>
        </div>
        <p class="text-muted mobile-text-lg mb-0">Robot uczy się na Twoich danych.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var modalEl = document.getElementById("submitSuccessModal");
    if (!modalEl || !window.bootstrap) {
      return;
    }
    var modal = new bootstrap.Modal(modalEl);
    modal.show();
    setTimeout(function () {
      modal.hide();
    }, 4000);

    var verifyButton = document.getElementById("verifyPriceButton");
    var statusEl = document.getElementById("verifyPriceStatus");
    var resultEl = document.getElementById("verifyPriceResult");
    if (!verifyButton) {
      return;
    }

    function getCookie(name) {
      var value = "; " + document.cookie;
      var parts = value.split("; " + name + "=");
      if (parts.length === 2) {
        return parts.pop().split(";").shift();
      }
      return "";
    }

    verifyButton.addEventListener("click", function () {
      var submissionId = verifyButton.getAttribute("data-submission-id");
      if (!submissionId) {
        return;
      }

      statusEl.textContent = "Sprawdzam zasoby internetowe...zaczekaj chwilę.";
      statusEl.classList.remove("d-none");
      resultEl.textContent = "";
      verifyButton.disabled = true;

      fetch("{% url 'estimation-verify' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: "submission_id=" + encodeURIComponent(submissionId),
      })
        .then(function (response) {
          return response.json().then(function (data) {
            return { ok: response.ok, data: data };
          });
        })
        .then(function (payload) {
          if (!payload.ok) {
            var details = "";
            if (payload.data && payload.data.diagnostics) {
              try {
                details = " Details: " + JSON.stringify(payload.data.diagnostics);
              } catch (e) {
                details = " Details: [unavailable]";
              }
            }
            throw new Error((payload.data.error || "Request failed.") + details);
          }
          resultEl.textContent = payload.data.text;
        })
        .catch(function (error) {
          resultEl.textContent = "Błąd: " + error.message;
        })
        .finally(function () {
          verifyButton.disabled = false;
          statusEl.classList.add("d-none");
        });
    });
  });
</script>
{% endblock %}
